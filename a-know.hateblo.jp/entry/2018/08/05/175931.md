---
Title: 読書メモ・詳解システムパフォーマンス 第11章／クラウドコンピューティング
Category:
- 本
- インフラ関連技術
Date: 2018-08-05T17:59:31+09:00
URL: https://blog.a-know.me/entry/2018/08/05/175931
EditURL: https://blog.hatena.ne.jp/a-know/a-know.hateblo.jp/atom/entry/10257846132607838276
---

「詳解システムパフォーマンス」の読書メモシリーズ・第10弾。

* [https://blog.a-know.me/entry/2017/04/24/192233:title]
* [https://blog.a-know.me/entry/2017/04/27/171809:title]
* [https://blog.a-know.me/entry/2017/04/29/104057:title]
* [https://blog.a-know.me/entry/2017/05/07/120526:title]
* [https://blog.a-know.me/entry/2017/06/11/162926:title]
* [https://blog.a-know.me/entry/2017/07/15/131555:title]
* [https://blog.a-know.me/entry/2017/08/15/121922:title]
* [https://blog.a-know.me/entry/2017/10/30/222529:title]
* [https://blog.a-know.me/entry/2018/07/21/190242:title]


[asin:4873117909:detail]

## 感想
- 自分が日頃慣れ親しんでいるのは「ハードウェア仮想化」による仮想マシンであることを知った
    - 「OS仮想化」知らなかった......
- そして、多くの点で「OS仮想化」の方が優れていることを知った
    - ただ、異なるカーネルバージョンを動かせる、というハードウェア仮想化のメリットは大きい
- 会社の同僚が「dom0が〜〜」と言っていたのが何だったのか、ようやくわかった。。
    - ただのホスト名かと思っていた......
- パブリッククラウドを使うときにも、この章に書かれているようなことを思い浮かべながら使うと良さそう



<!-- more -->


## 知らなかった
- OS仮想化
    - 「コンテナ型仮想化」とも
    - ハードウェア仮想化と大きく違う点として、カーネルがひとつだけしか実行されていない
    - メリット
        - ゲストアプリケーションのI/Oにかかるパフォーマンスオーバーヘッドがほとんどない
            - ゲストアプリケーションがホストカーネルに直接システムコールを実行できるため
        - ゲストにアロケートされるメモリは、ゲストが全てを使うことができる
            - ゲストカーネル・ハイパーバイザなどに専有されることがない
        - ファイルシステムキャッシュが統一されており、ホストとゲストで二重にキャッシュされることはない
        - ホストからすべてのゲストプロセスを観察できるというデバッグのしやすさ
        - CPUが実CPU（vCPUではない）。アダプティブミューテックスロックの前提条件が有効。
            - アダプティブミューテックスロック：Spin locksとMutex locksのハイブリッド
            -  ロック獲得しているスレッドが現在他のCPUで実行中の場合はスピンする。他のCPUでなければブロックするか、スピンの閾値を超えたらブロックする。 
            - CPUリソースを無駄にせず、低レイテンシなロックアクセスができるように最適化されている。
            - [https://memo.yuuk.io/entry/2016/03/27/155250:title]
    - デメリット
        - カーネルパニックがすべてのゲストに影響を及ぼす
        - ゲストは、異なるカーネルバージョンを実行できない
- ハードウェア仮想化
    - 以下のようなタイプがある
    - 完全仮想化ーバイナリ変換
        - 仮想ハードウェアコンポーネントから構成された完全な仮想システム。
        - 必要に応じてプロセッサの直接実行と命令のバイナリ変換を使い分ける
        - 物理リソースに働きかけるゲストカーネル命令は識別され、バイナリ変換される。
    - 完全仮想化ーハードウェア支援
        - 仮想ハードウェアコンポーネントから構成された完全な仮想システム。
        - 仮想マシンをより効率よく実行するためのプロセッサのサポート（AMD-V, Intel VT-x エクステンション）を利用する
        - バイナリ命令を変換するのではなく、ゲストカーネルの特権的な命令をもっと特権的なVMMに強制的にトラップさせ、VMMが特権をエミュレートして仮想化をサポートする。
    - 準仮想化
        - ゲストOSがすべてのコンポーネントを完全に仮想化しなくても済むように、効率よくホストリソースを利用するためのインターフェイス（ハイパーコール）を含む仮想化システムの提供。
        - ゲストOSが準仮想化をサポートしてくれることに依存することになる
        - 仮想化しなければならないゲストOSの命令は、ハイパーバイザを呼び出すハイパーコールに置き換えられる。
    - ハイブリッド仮想化
        - ハードウェア支援仮想化と準仮想化の両方を使うもの
    - ハードウェア仮想化はいずれも、ゲストOSがハードウェアにアクセスしようとするたびに、オーバーヘッドを生み出す。
        - コマンドを仮想デバイスから物理デバイスに変換しなければならないため
    - 仮想化のもとでは、ゲストからハードウェアへの新しいメモリページのマッピング（ページフォルト）は、2段階でおこなわれる。
        1. ゲストカーネルが仮想メモリからゲストの物理メモリへの変換をおこなう
        1. ハイパーバイザのVMMがゲストの物理メモリからホストの物理メモリ（実メモリ）への変換をおこなう
- ハイパーバイザには2つのタイプがある
    - タイプ１
        - ほかのホストのカーネル / ユーザーレベルソフトウェアとしてハイパーバイザを実行するのではなく、プロセッサ上でハイパーバイザを直接実行する
        - ネイティブハイパーバイザ、ベアメタルハイパーバイザとも呼ばれる。
        - ゲストVMのために自分自身のCPUスケジューラを内蔵している
        - Xenなどはこれに分類される
    - タイプ２
        - ホストOSのカーネルによって実行され、カーネルレベルモジュールとユーザーレベルモジュールから構成することができる
        - ホストOSは、ハイパーバイザを管理し新しいゲストを起動する特権を持っている
        - KVMなどはこれに分類される
- 二重仮想化
    - 個々のKVMインスタンスを独自のセキュアなゾーンにカプセル化することでセキュリティ保護の二重化を図ること
- Linuxでは、perf(1)がKVMとXenの両方に対してトレースポイントを提供している

## 復習
- CPU数が増えると、CPUキャッシュのコヒーレンシ（キャッシュの一貫性）を維持するのも大変になる
- バースティング：可能ならただちにCPUリソースを動的にアロケートする戦略


## なるほど
- ハードウェア仮想化での可観測性
    - 何が観測できるかはハイパーバイザのタイプと可観測性ツールが起動される位置によって左右される
    - タイプ１かタイプ２の場合
        - すべての物理リソースは標準のOSツールを使って観察可能
        - I/OはI/Oプロキシから観察可能
        - ゲストの内部は直接の観察は不可能
    - ゲストから
        - 物理リソースとその使用状況は、一般的に観察不可能
        - ゲストが使っている仮想リソースとその使用状況は観察可能
- 仮想化テクノロジーを比較したとき、パフォーマンス面での比較は多いが、可観測性の比較が見落とされやすい
    - 不要な仕事を見つけ、取り除くことでパフォーマンスを大きく向上させられる、という点では、可観測性への考慮は重要


<div>
<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- article-bottom2 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3463034538369189"
     data-ad-slot="5274552934"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<a href="https://bit.ly/grass-graph" target='blank' rel="nofollow"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/a-know/20170405/20170405220342.png"></a>
<br>
</div>

<div>
<a href='https://cloud.feedly.com/#subscription%2Ffeed%2Fhttp%3A%2F%2Fblog.a-know.me%2Ffeed'  target='blank'><img id='feedlyFollow' src='https://s3.feedly.com/img/follows/feedly-follow-rectangle-volume-small_2x.png' alt='follow us in feedly' width='65' height='20'></a>



<iframe src="https://blog.hatena.ne.jp/a-know/a-know.hateblo.jp/subscribe/iframe" allowtransparency="true" frameborder="0" scrolling="no" width="150" height="28"></iframe>
</div>




<script src="https://moshi-moshi.moshimo.works/moshimoshi/a_know_blog/2018-08-05-175931?title=%e8%aa%ad%e6%9b%b8%e3%83%a1%e3%83%a2%e3%83%bb%e8%a9%b3%e8%a7%a3%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0%e3%83%91%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%b3%e3%82%b9%20%e7%ac%ac11%e7%ab%a0%ef%bc%8f%e3%82%af%e3%83%a9%e3%82%a6%e3%83%89%e3%82%b3%e3%83%b3%e3%83%94%e3%83%a5%e3%83%bc%e3%83%86%e3%82%a3%e3%83%b3%e3%82%b0"></script>
