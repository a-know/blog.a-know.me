---
Title: GKEã‚¯ãƒ©ã‚¹ã‚¿ã«å°ã•ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é…å‚™ã—ã¦ã€ã¤ã„ã§ã«httpsåŒ–ã—ã¦ã¿ã‚‹
Category:
- GCP
- ã‚³ãƒ³ãƒ†ãƒŠé–¢é€£æŠ€è¡“
- è©¦ã—ã¦ã¿ãŸ
Date: 2018-06-24T22:44:24+09:00
URL: https://blog.a-know.me/entry/2018/06/24/224424
EditURL: https://blog.hatena.ne.jp/a-know/a-know.hateblo.jp/atom/entry/17391345971657264692
---

å‰å›ã®ã¤ã¥ãã€‚å‰å›ã¯ã€preemptible instance ã‚’ä½¿ã£ã¦ã§ãã‚‹ã ã‘å®‰ä¸ŠãŒã‚ŠãªGKEï¼ˆk8sï¼‰ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œã£ã¦ã¿ãŸã€‚



[https://blog.a-know.me/entry/2018/06/17/220222:embed:cite]



ã›ã£ã‹ãGKEã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œã£ãŸã®ã§ã€ãã®ä¸Šã§ãªã«ã‹ã‚’å‹•ã‹ã—ã¦ã¿ãŸã„ã€‚ãªã«ã‹ã¨ã¯ã¤ã¾ã‚ŠWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚ãã—ã¦2018å¹´ã‚‚6æœˆãªã®ã§ã€æœ€åˆã‹ã‚‰ https åŒ–ã•ã‚ŒãŸçŠ¶æ…‹ã‚’ç›®æŒ‡ã—ã¦ã¿ãŸã„ã€‚ä»Šå›ã¯ãã‚Œã‚’è©¦ã—ã¦ã¿ãŸã‚‚ã®ã®ãƒ¡ãƒ¢ã€‚


<!-- more -->

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- article-top -->
<ins class="adsbygoogle"
     style="display:inline-block;width:728px;height:90px"
     data-ad-client="ca-pub-3463034538369189"
     data-ad-slot="8367620130"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>


## Helm & cert-manager ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
å°‘ã—èª¿ã¹ã¦ã¿ãŸã¨ã“ã‚ã€ä»Šå›ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã¯[cert-manager](https://github.com/jetstack/cert-manager)ã¨ã„ã†ã‚‚ã®ã‚’æ´»ç”¨ã™ã‚‹ã®ãŒè‰¯ã„ã‚ˆã†ã ã£ãŸã€‚cert-manager ã¯ã€Œk8sç’°å¢ƒã§ã® Let's encrypt ã‚’ä½¿ã£ãŸ SSL/TLS è¨¼æ˜æ›¸ã®å–å¾—ãƒ»ç®¡ç†ãƒ•ãƒ­ãƒ¼ã‚’ã†ã¾ã„ã“ã¨ã‚„ã£ã¦ãã‚Œã‚‹å›ã€ã€ã¨ã„ã£ãŸãƒ„ãƒ¼ãƒ«ã®ã‚ˆã†ã ã£ãŸï¼ˆ`Automatically provision and manage TLS certificates in Kubernetes` ï¼‰ã€‚cert-manager ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¯ Helm ã‚’ä½¿ã†ã€‚


```sh
$ brew install kubernetes-helm
```


Helm ã¯ã€k8s ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã¿ãŸã„ãªã‚‚ã®ã‚‰ã—ã„ã€‚Helm ã«ã¾ã¤ã‚ã‚‹ã‚‚ã®ã¨ã—ã¦ã€`chart` ã¨ `tiller` ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚‹ã€‚


`chart` ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆä»Šå›ã®ã‚±ãƒ¼ã‚¹ã ã¨ã€Œcert-manager ã® chart ã‚’ä½¿ã†ã€ã€ã¨ã„ã†ã‹ã‚“ã˜ï¼‰ã€`tiller` ã¯ã‚¯ãƒ©ã‚¹ã‚¿å´ã«é…ç½®ã™ã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‰ã—ã„ã€‚ã“ã® tiller ã¯Helm ã‚’ä½¿ã£ã¦ chart ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ãã«ã¯å¿…é ˆã¨ãªã‚‹ã‚‚ã®ã®ã‚ˆã†ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ tiller ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚‚å«ã‚ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹æ§˜å­ã€‚

```sh
$ helm init --upgrade
Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.
```

`has been installed into your Kubernetes Cluster` ã€ã‚ã‚‰ãã†ã§ã—ãŸã‹ã€‚GKEã ã¨æœ€åˆã‹ã‚‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã‚‹ã¿ãŸã„ã€å¤±ç¤¼ã—ã¾ã—ãŸã€‚


ã§ã¯ç¶šã„ã¦ cert-manager ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚


```sh
$ curl -sL https://github.com/jetstack/cert-manager/archive/v0.3.0.tar.gz | tar xv
$ helm install --name cert-manager --namespace kube-system cert-manager-0.3.0/contrib/charts/cert-manager
Error: release cert-manager failed: namespaces "kube-system" is forbidden: User "system:serviceaccount:kube-system:default" cannot get namespaces in the namespace "kube-system": Unknown user "system:serviceaccount:kube-system:default"
```

ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã€‚Unknown userã€ãªã‚‹ã»ã©ï¼Ÿã€€ä»Šå›ã®ä½œæ¥­ã®ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚Šãã†ã€‚

```sh
$ kubectl create serviceaccount cert-manager --namespace kube-system
$ kubectl create clusterrolebinding cert-manager --clusterrole=cluster-admin --serviceaccount=kube-system:cert-manager
```

ã“ã†ã—ã¦ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¦ã€å†åº¦ `helm init` ã€‚ã‚“ã§ `helm install` ã€‚

```sh
$ helm init --service-account cert-manager --upgrade
Tiller (the Helm server-side component) has been upgraded to the current version.
Happy Helming!
$ helm install --name cert-manager --namespace kube-system cert-manager-0.3.0/contrib/charts/cert-manager
NAME:   cert-manager
LAST DEPLOYED: Sat Jun 23 14:57:30 2018
NAMESPACE: kube-system
STATUS: DEPLOYED
ï¼ˆä¸­ç•¥ï¼‰
NOTES:
cert-manager has been deployed successfully!

In order to begin issuing certificates, you will need to set up a ClusterIssuer
or Issuer resource (for example, by creating a 'letsencrypt-staging' issuer).

More information on the different types of issuers and how to configure them
can be found in our documentation:

http://cert-manager.readthedocs.io/en/latest/reference/issuers.html

For information on how to configure cert-manager to automatically provision
Certificates for Ingress resources, take a look at the `ingress-shim`
documentation:

http://cert-manager.readthedocs.io/en/latest/reference/ingress-shim.html
```

ã§ããŸã£ã½ã„ã€‚

## è¨¼æ˜æ›¸ã®ä½œæˆ
ã“ã‚Œã¾ã§åƒ•ãŒè‡ªåˆ†ã§ Let's encrypt ã‚’ä½¿ã£ãŸè¨¼æ˜æ›¸ç”Ÿæˆã‚’ãŠã“ãªã£ãŸéš›ã«ã¯ã€å¯¾è±¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ç‰¹å®šã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’å—ã‘ã‚‰ã‚Œã‚‹ç’°å¢ƒã‚’ç”¨æ„ã—ã¦......ã€ã¨ã„ã†æ–¹æ³•ã§ã®å–å¾—ã ã£ãŸï¼ˆã“ã®æ–¹å¼ã¯ HTTP-01ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã€ã¨ã„ã†ã‚‚ã®ã‚‰ã—ã„ï¼‰ã€‚ä»Šå›ã¯ã“ã®æ–¹å¼ã§ã¯ãªãã€ã€ŒDNS ã® TXT ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‹•çš„ã«ç”Ÿæˆã€çªãåˆã‚ã›ã‚‹ã“ã¨ã§ãƒ‰ãƒ¡ã‚¤ãƒ³æ‰€æœ‰ã®ç¢ºèªã‚’ãŠã“ãªã†ã€ã¨ã„ã† DNS-01ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ–¹å¼ã‚’å–ã£ã¦ã¿ãŸã„ã¨æ€ã†ã€‚


ä»Šå›è¨¼æ˜æ›¸ã®å–å¾—å¯¾è±¡ã¨ãªã‚‹åƒ•ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®DNSã«ã¯ Route53 ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã ã‘ã©ã€å¹¸ã„ cert-manager ã¯ Route53 ã«ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹ã¨ã®ã“ã¨ãªã®ã§ã€ã‚ã¨ã¯ cert-manager ãŒ Route53 ã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’æŒã¤å¿…è¦ãŒã‚ã‚‹ã€‚


[ã“ã“ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/jetstack/cert-manager/blob/master/docs/reference/issuers/acme/dns01.rst)ã‚’è¦‹ã‚‹ã¨ã€IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œã£ã¦ AccessKeyID & SecretAccessKey ã‚’å–å¾—ã—ã¦ãŠã‘ã°ã‚ˆã•ãã†ãªã®ã§ã€ã¾ãšã¯ãã®ä½œæˆã‚’AWSå´ã§ãŠã“ãªã†ã€‚æ‰‹é †ã¯å‰²æ„›ã™ã‚‹ã‘ã©ã€å¿…è¦ãªã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ã‚‚å…ˆè¿°ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¦ã€ä»¥ä¸‹ã®é€šã‚Šã€‚

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "route53:GetChange",
            "Resource": "arn:aws:route53:::change/*"
        },
        {
            "Effect": "Allow",
            "Action": "route53:ChangeResourceRecordSets",
            "Resource": "arn:aws:route53:::hostedzone/*"
        },
        {
            "Effect": "Allow",
            "Action": "route53:ListHostedZonesByName",
            "Resource": "arn:aws:route53:::hostedzone/*"
        }
    ]
}
```

ã¡ãªã¿ã«ã€ã“ã®ãƒãƒªã‚·ãƒ¼ã®ã¾ã¾å‹•ã‹ã—ã¦ã¿ãŸã‚‰ã€Œ`route53:ListHostedZonesByName`  ã® resource ã¯ `*` ã«ã—ã‚ã‚„ã€ã£ã¦æ€’ã‚‰ã‚ŒãŸã€‚ç´ ç›´ã« `*` ã«ã—ãŸã‚‰ã†ã¾ãã„ã£ãŸã®ã§ã€ã“ã“ã¯ã“ã‚Œã§ã„ã„ã®ã‹ã‚‚ã—ã‚Œãªã„ï¼Ÿ


èªè¨¼æƒ…å ±ã®ä½œæˆãŒã§ããŸã‚‰ã€SecretAccessKey ã®æ–¹ã‚’ `kubectl create secret` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ç™»éŒ²ã—ã¦ãŠãã€‚ã“ã‚Œã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦ã¯ heroku ã® ç’°å¢ƒå¤‰æ•°ã¿ãŸã„ãªã‹ã‚“ã˜ã‹ãªã€‚

```sh
$ kubectl create secret generic prod-route53-credentials-secret --from-literal=secret-access-key=<secret+key/id>
secret "prod-route53-credentials-secret" created
```

`generic` ã®ã†ã—ã‚ã¯åå‰ã€`--from-literal` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ `key=value` å½¢å¼ã§ã®æŒ‡å®šã«ãªã‚‹ã‚“ã ã‘ã©ã€åå‰ã¨keyã«ã¤ã„ã¦ã‚‚ã•ã£ãã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’è¸è¥²ã—ã¦ã¿ã¦ã„ã‚‹ã€‚


ã“ã“ã¾ã§ã§ããŸã‚‰ã€Issuerï¼ˆè¨¼æ˜æ›¸ã‚’ç”Ÿæˆã™ã‚‹ CA è¨­å®šï¼‰ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã“ã¨ã‚’ãŠã“ãªã†ã€‚

```sh
$ kubectl apply -f - << EOF
apiVersion: certmanager.k8s.io/v1alpha1
kind: Issuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    # The ACME server URL
    server: https://acme-v01.api.letsencrypt.org/directory
    # Email address used for ACME registration
    email: admin@example.com
    # Name of a secret used to store the ACME account private key
    privateKeySecretRef:
      name: letsencrypt-prod
    # Enable the HTTP-01 challenge provider
    http01: {}
    # ACME dns-01 provider configurations
    dns01:
      # Here we define a list of DNS-01 providers that can solve DNS challenges
      providers:
      - name: prod-dns
        route53:
          region: ap-northeast-1
          # optional if ambient credentials are available; see ambient credentials documentation
          accessKeyID:<ACCESS_KEY_ID>
          secretAccessKeySecretRef:
              name: prod-route53-credentials-secret
              key: secret-access-key
EOF
issuer "letsencrypt-prod" created
```

ã‚“ãƒ¼ã€Route53 ã ã‘ã©ãƒªãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šã„ã‚‹ã®ã‹......ï¼Ÿã€€ã¨ã‚Šã‚ãˆãšæ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ã—ã¦ã¿ãŸã‘ã©ã‚‚ã€‚


ã¡ã‚ƒã‚“ã¨ä½œæˆã§ããŸã‹ã©ã†ã‹ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã‚‹ã€‚


```sh
$ kubectl describe issuer
Name:         letsencrypt-prod
Namespace:    default
Labels:       <none>
ï¼ˆä¸­ç•¥ï¼‰
Status:
  Acme:
    Uri:  https://acme-v02.api.letsencrypt.org/acme/acct/12345678
  Conditions:
    Last Transition Time:  2018-06-23T06:53:30Z
    Message:               The ACME account was registered with the ACME server
    Reason:                ACMEAccountRegistered
    Status:                True
    Type:                  Ready
Events:                    <none>
```

`Status: True` `Type: Ready` ã®ã‚ãŸã‚ŠãŒå¤§ä¸ˆå¤«ãã†ãªé›°å›²æ°—ãŒã‚ã‚‹ã€‚


ãã—ã¦ã€ã“ã“ã§ä½œã£ãŸ Issuer ã‚’ä½¿ã£ã¦ã€è¨¼æ˜æ›¸ãƒ»Certificate ã‚’ä½œæˆã™ã‚‹ã€‚


```sh
$ kubectl apply -f - <<EOF
apiVersion: certmanager.k8s.io/v1alpha1
kind: Certificate
metadata:
  name: www-example-com
  namespace: default
spec:
  secretName: cert-manager-tls
  issuerRef:
    name: letsencrypt-prod
  commonName: www.example.com
  dnsNames:
  - www.example.com
  acme:
    config:
    - dns01:
        provider: prod-dns
      domains:
      - www.example.com
EOF
certificate "www-example-com" created
```

åŒã˜ãä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§çŠ¶æ³ç¢ºèªã€‚

```sh
$ kubectl describe certificate
Name:         www-example-com
Namespace:    default
Labels:       <none>
ï¼ˆä¸­ç•¥ï¼‰
Events:
  Type    Reason       Age   From          Message
  ----    ------       ----  ----          -------
  Normal  CreateOrder  8s    cert-manager  Created new ACME order, attempting validation...
```

ãªã‚‹ã»ã©ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã¿ã‚‹ã€‚

```
Events:
  Type    Reason          Age   From          Message
  ----    ------          ----  ----          -------
  Normal  CreateOrder     2m    cert-manager  Created new ACME order, attempting validation...
  Normal  DomainVerified  1m    cert-manager  Domain "www.example.com" verified with "dns-01" validation
  Normal  IssueCert       1m    cert-manager  Issuing certificate...
  Normal  CertObtained    1m    cert-manager  Obtained certificate from ACME server
  Normal  CertIssued      1m    cert-manager  Certificate issued successfully
```

`Certificate issued successfully` !! ğŸ‰


ã¡ã‚‡ã£ã¨é•·ã‹ã£ãŸã‘ã©ã€ã“ã‚Œã§è¨¼æ˜æ›¸ã®ä½œæˆã¾ã§ãŒå®Œäº†ã€‚


ã¤ã¥ã„ã¦ã€ã‚¯ãƒ©ã‚¹ã‚¿ä¸Šã§å‹•ã‹ã™ãŸã‚ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã¤ãã‚‹ã€‚


##  "å°ã•ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³" ã‚’ã¤ãã‚‹
Go ã§ã—ã‚…ã£ã¨ä½œã£ãŸã€‚ã“ã‚“ãªâ†“ã‹ã‚“ã˜ã§ã€‚

```go
package main

import (
	"log"
	"net/http"

	"github.com/a-know/small-app/handlers"
	"github.com/go-chi/chi"
)

func main() {
	r := chi.NewRouter()

	r.Get("/heartbeat", handlers.HandleHeartbeat)

	log.Printf("small-app started.")
	http.ListenAndServe(":8080", r)
}
```

```go
package handlers

import (
	"fmt"
	"net/http"
)

func HandleHeartbeat(w http.ResponseWriter, r *http.Request) {
	w.WriteHeader(http.StatusOK)
	fmt.Fprintf(w, "OK")
}
```

`8080` ãƒãƒ¼ãƒˆã« `/heartbeat` ã« GET ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚‰ `OK` ã¨è¿”ã™ã ã‘ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚ã•ã„ãã‚“ `go-chi/chi` ã‚’ä½¿ã£ã¦ã¿ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã‚‚ãã‚Œã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚

## ä½œã£ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«å›ºã‚ã‚‹
ä¹…ã€…ã«Dockerfileã‚’æ›¸ã„ãŸã€‚ã“ã‚“ãªæ„Ÿã˜ã§ã„ã„ã®ã‹ãª......ã€‚

```dockerfile
# for build
FROM golang:1.10-alpine AS build

RUN apk update && apk upgrade \
    && apk add curl git

RUN curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh

WORKDIR /go/src/github.com/a-know/small-app
COPY . .

RUN dep ensure
RUN go build -o small-app

# for artifacts
FROM golang:1.10-alpine
COPY --from=build /go/src/github.com/a-know/small-app/small-app /bin/small-app

EXPOSE 8080
RUN chmod +x /bin/small-app
CMD /bin/small-app
```

## ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ Google Container Registry ã« push ã™ã‚‹
GKEã‚¯ãƒ©ã‚¹ã‚¿ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ã‚’è€ƒãˆã‚‹ã¨ã€GCR ã« push ã—ã¦ã‚ã‚‹ã»ã†ãŒä½•ã‹ã¨æ¥½ãªã®ã§......ã€‚

```sh
$ docker build -t asia.gcr.io/<PROJECT_ID>/small-app:latest .
$ gcloud docker -- push asia.gcr.io/<PROJECT_ID>/small-app:latest
```

## ãƒ“ãƒ«ãƒ‰ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒ©ã‚¹ã‚¿ä¸Šã®é…å‚™
ä»¥ä¸‹ã®ã‚ˆã†ãª yaml ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦ãŠã„ã¦......ã€‚

```yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: small-app
  labels:
    run: small-app
spec:
  replicas: 10
  template:
    metadata:
      labels:
        run: small-app
    spec:
      containers:
      - name: small-app
        image: asia.gcr.io/<PROJECT_ID>/small-app:latest
        readinessProbe:
          httpGet:
            path: /heartbeat
            port: 8080
          initialDelaySeconds: 3
          periodSeconds: 3
        ports:
        - containerPort: 8080
```

ä»Šå›ä½œã£ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚ã¾ã‚Šã«å°ã•ã™ãã¦ã€200 ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã›ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒ `/heartbeat` ãªã„ã®ã§ã€ `readinessProbe` ã§ãã“ã‚’æŒ‡å®šã—ã¦ãŠãã€‚


ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚

```sh
$ kubectl create -f deployment.yml
deployment "small-app" created
```

## ã‚¯ãƒ©ã‚¹ã‚¿ä¸Šã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã« http ã§ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹


æ¬¡ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ NordPort ã®ä½œæˆã€‚

```sh
$ kubectl expose deployment small-app --target-port=8080 --type=NodePort
service "small-app" exposed
```

ç¶šã„ã¦é™çš„IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã€‚

```sh
$ gcloud compute addresses create small-app-ip --global
$ gcloud compute addresses describe small-app-ip --global --format='get(address)'
xx.xxx.x.xx
```

ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã¦ã€è¨­å®šå¯¾è±¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«Aãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹ã€‚ã“ã®ä½œæ¥­ã€ä»Šå›åƒ•ã®å ´åˆã¯ Route53 ã§ã®ä½œæ¥­ã«ãªã‚‹ã®ã§ã€ãã‚Œã‚‚ã“ã“ã§ã¯å‰²æ„›ã€‚


æœ€å¾Œã« Ingress ã‚’ä½œæˆã™ã‚‹ã€‚å¤šåˆ†ã“ã‚Œã‚’ã‚„ã£ãŸæ™‚ç‚¹ã§ã€Œæ ¼å®‰GKEã‚¯ãƒ©ã‚¹ã‚¿ã€ã§ã¯ãªããªã‚‹ã¨æ€ã†ã®ã§ã€ãã®ç‚¹ã¯æ³¨æ„ï½—ï¼ˆå¤šåˆ†Â¥2,000/æœˆ ãã‚‰ã„ãƒ—ãƒ©ã‚¹ã§æ›ã‹ã‚‹ã“ã¨ã«ãªã‚‹ã€‚ãã‚Œã§ã‚‚åƒ•ã¯é‹ç”¨ã—ã¤ã¥ã‘ã‚‹ã‘ã©ã­ï¼ï½—ï¼‰

```sh
kubectl apply -f - << EOF
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: small-app
  annotations:
    kubernetes.io/ingress.global-static-ip-name: "small-app-ip"
    kubernetes.io/ingress.class: "gce"
spec:
  tls:
  - secretName: cert-manager-tls
    hosts:
      - www.example.com
  backend:
    serviceName: small-app
    servicePort: 8080
EOF
```

Ingress ã®çŠ¶æ³ã‚’ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã€‚`--watch` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ä¸€å®šé–“éš”ã§çµæœã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¦ãã‚Œã‚‹ã£ã½ã„ã€‚

```sh
$ kubectl get ingress --watch
NAME          HOSTS     ADDRESS   PORTS     AGE
small-app   *                   80, 443   58s
small-app   *         xx.xxx.x.xx   80, 443   1m
```

ADDRESS ã«ã•ã£ãå–å¾—ã—ãŸé™çš„IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå‡ºãŸï¼


ã•ã‚‰ã«ã€Ingress ã®è©³ç´°ãªçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã€‚

```sh
$ kubectl describe ingress
Name:             small-app
Namespace:        default
Address:          xx.xxx.x.xx
ï¼ˆä¸­ç•¥ï¼‰
Annotations:
  forwarding-rule:        k8s-fw-default-small-app--b0bac8830034cfc9
  https-forwarding-rule:  k8s-fws-default-small-app--b0bac8830034cfc9
  ssl-cert:               k8s-ssl-default-small-app--b0bac8830034cfc9
  url-map:                k8s-um-default-small-app--b0bac8830034cfc9
  backends:               {"k8s-be-31982--b0bac8830034cfc9":"Unknown"}
  https-target-proxy:     k8s-tps-default-small-app--b0bac8830034cfc9
  target-proxy:           k8s-tp-default-small-app--b0bac8830034cfc9
Events:
  Type    Reason   Age              From                     Message
  ----    ------   ----             ----                     -------
  Normal  ADD      3m               loadbalancer-controller  default/small-app
  Normal  CREATE   2m               loadbalancer-controller  ip: xx.xxx.x.xx
  Normal  Service  2m (x2 over 2m)  loadbalancer-controller  default backend set to small-app:31982
```

Annotations ã® backends ã®ã¨ã“ã‚ãŒ `Unknown` ã«ãªã£ã¦ã„ã‚‹ã€‚ã©ã†ã‚„ã‚‰ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€Deployment ã®éš›ã«æŒ‡å®šã—ãŸ å„ã‚³ãƒ³ãƒ†ãƒŠã®readinessProbe ã«å¯¾ã—ã¦ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ã‚ˆã†ãªã“ã¨ã‚’ãŠã“ãªã£ã¦ã‚‹ã£ã½ã„ã€‚ï¼ˆDeployment ã« readinessProbe ã®æŒ‡å®šãŒãªã„å ´åˆã€ `/` ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒ 200 ã«ãªã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã‚‹ã€‚https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/cluster-loadbalancing/glbc#limitationsï¼‰


ã—ã°ã‚‰ãå¾…ã£ã¦ã€ã‚‚ã†ä¸€åº¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã€‚


```sh
$ kubectl describe ingress
Name:             small-app
Namespace:        default
Address:          xx.xxx.x.xx
ï¼ˆä¸­ç•¥ï¼‰
Annotations:
  backends:               {"k8s-be-31982--b0bac8830034cfc9":"HEALTHY"}
  forwarding-rule:        k8s-fw-default-small-app--b0bac8830034cfc9
  https-forwarding-rule:  k8s-fws-default-small-app--b0bac8830034cfc9
  ssl-cert:               k8s-ssl-default-small-app--b0bac8830034cfc9
  target-proxy:           k8s-tp-default-small-app--b0bac8830034cfc9
  url-map:                k8s-um-default-small-app--b0bac8830034cfc9
  https-target-proxy:     k8s-tps-default-small-app--b0bac8830034cfc9
Events:
  Type    Reason   Age              From                     Message
  ----    ------   ----             ----                     -------
  Normal  ADD      10m              loadbalancer-controller  default/small-app
  Normal  CREATE   9m               loadbalancer-controller  ip: xx.xxx.x.xx
  Normal  Service  3m (x4 over 9m)  loadbalancer-controller  default backend set to small-app:31982
```

`HEALTHY` ã«ãªã£ãŸï¼å–œã³å‹‡ã‚“ã§ã€`https://www.example.com/heartbeat` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã€‚


[f:id:a-know:20180624160122p:plain]


ã‚ã§ãŸã„ ğŸ‰ğŸ‰ğŸ‰ã€€ã“ã‚Œã§ä»Šå›ã®ç›®çš„ã¯é”æˆï¼


## ã¾ã¨ã‚
- GKE ä¸Šã§Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã™ãŸã‚ã®ç¬¬ä¸€æ­©ã¨ã—ã¦ã€å°ã•ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã£ã¦ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦ãƒ“ãƒ«ãƒ‰ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã—ã¦ã¿ãŸ
- GKEã§å‹•ãk8sã‚¯ãƒ©ã‚¹ã‚¿ã«è¨¼æ˜æ›¸ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ãŸã‚ã«ã€cert-manager ã‚’æ´»ç”¨ã—ãŸ
    - cert-manager ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã«ã¯ Helm ã‚’ä½¿ç”¨ã™ã‚‹
    - DNS-01 ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ–¹å¼ã‚’æ¡ã‚‹å ´åˆã¯ã€cert-manager ãŒDNSã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãŠã“ãªãˆã‚‹æ¨©é™ã‚’ä¸ãˆã‚‹å¿…è¦ãŒã‚ã‚‹
    - è¨¼æ˜æ›¸ã¯ Ingress ã«å¯¾ã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¯èƒ½
- ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚³ãƒ³ãƒ†ãƒŠãŒ `/` ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾ã—ã¦ 200 ã‚’è¿”ã›ãªã„å ´åˆã¯ã€åˆ¥é€” `readinessProbe` ã‚’æŒ‡å®šã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ç‚¹ã¯æ³¨æ„


ä»Šå›ä½œæˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã®ã¯æœ¬å½“ã«å°ã•ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã ã‘ã©ã‚‚ã€ã¨ã¯ã„ãˆãã‚Œã§ã‚‚ç«‹æ´¾ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚ä»Šåº¦ä½•ã‹ã—ã‚‰Webã‚¢ãƒ—ãƒªã‚’ä½œã£ãŸã¨ãã«ã¯ã€ãœã²GKEä¸Šã§å‹•ã‹ã—ã¦ã¿ãŸã„ï¼


[asin:4839964580:detail]


## ã‚ã¡ã‚ƒãã¡ã‚ƒå‚è€ƒã«ã—ãŸ
- [https://qiita.com/apstndb/items/3a39a1e6acacbbc30765:title]
- [https://cloud.google.com/kubernetes-engine/docs/tutorials/http-balancer:title]
- [https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/:title]




<div>
<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- article-bottom2 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:250px"
     data-ad-client="ca-pub-3463034538369189"
     data-ad-slot="5274552934"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<a href="https://bit.ly/grass-graph" target='blank' rel="nofollow"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/a/a-know/20170405/20170405220342.png"></a>
<br>
</div>

<div>
<a href='https://cloud.feedly.com/#subscription%2Ffeed%2Fhttp%3A%2F%2Fblog.a-know.me%2Ffeed'  target='blank'><img id='feedlyFollow' src='https://s3.feedly.com/img/follows/feedly-follow-rectangle-volume-small_2x.png' alt='follow us in feedly' width='65' height='20'></a>



<iframe src="https://blog.hatena.ne.jp/a-know/a-know.hateblo.jp/subscribe/iframe" allowtransparency="true" frameborder="0" scrolling="no" width="150" height="28"></iframe>
</div>
